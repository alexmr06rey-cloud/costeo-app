<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Costeo BOM</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#0c1527;
      --text:#e8eefc;
      --muted:#97a3b6;
      --line:rgba(255,255,255,.10);
      --focus:rgba(96,165,250,.40);
      --btn:#15284a;
      --btn2:#103a34;
      --danger:#3b1320;
      --ok:#102a22;
      --warn:#2a240f;
      --radius:14px;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --pad:14px;

      --red:#ff5a7a;
      --amber:#ffd15a;
      --green:#52ffb0;
      --blue:#60a5fa;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(96,165,250,.18), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(94,234,212,.12), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,18,32,.92), rgba(11,18,32,.72));
      border-bottom:1px solid var(--line);
    }
    .topbar .inner{
      max-width:1200px;
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
      min-width:220px;
    }
    .brand b{ font-size:14px; letter-spacing:.2px; }
    .brand span{ font-size:12px; color:var(--muted); }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,18,34,.35);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    .dot{
      width:9px; height:9px; border-radius:50%;
      background: rgba(255,255,255,.25);
      box-shadow: 0 0 0 3px rgba(255,255,255,.05);
    }
    .dot.ok{ background: rgba(82,255,176,.85); box-shadow: 0 0 0 3px rgba(82,255,176,.12); }
    .dot.warn{ background: rgba(255,209,90,.90); box-shadow: 0 0 0 3px rgba(255,209,90,.12); }
    .dot.bad{ background: rgba(255,90,122,.90); box-shadow: 0 0 0 3px rgba(255,90,122,.12); }

    .selector{
      flex:1;
      display:flex;
      gap:10px;
      align-items:center;
      min-width:300px;
    }

    /* Layout */
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:14px;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--line);
      background: rgba(12,21,39,.55);
    }
    .card .hd b{ font-size:13px; letter-spacing:.2px; }
    .card .bd{ padding:14px; }

    /* Inputs */
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
    }
    .field{ position:relative; }
    input, select, textarea, button{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(10,18,34,.55);
      color:var(--text);
      padding:11px 11px;
      outline:none;
      font-size:14px;
    }
    input:focus, select:focus, textarea:focus{
      border-color: var(--focus);
      box-shadow: 0 0 0 3px rgba(96,165,250,.12);
    }
    textarea{ min-height:92px; resize:vertical; }

    .prefix{
      position:absolute;
      top:34px;
      left:11px;
      color:rgba(151,163,182,.85);
      font-size:13px;
      pointer-events:none;
    }
    .has-prefix input{ padding-left:28px; }

    .help{
      margin-top:6px;
      font-size:12px;
      color:rgba(151,163,182,.85);
    }
    .err{
      margin-top:6px;
      font-size:12px;
      color: rgba(255,90,122,.95);
      display:none;
    }

    .invalid input, .invalid select, .invalid textarea{
      border-color: rgba(255,90,122,.55);
      box-shadow: 0 0 0 3px rgba(255,90,122,.10);
    }
    .invalid .err{ display:block; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .grid2{ grid-template-columns: 1fr; }
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .row > *{ flex:1; }

    /* Buttons */
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(21,40,74,.9), rgba(21,40,74,.6));
      cursor:pointer;
      font-weight:650;
    }
    .btn:hover{ filter:brightness(1.06); }
    .btn.secondary{
      background: linear-gradient(180deg, rgba(16,58,52,.95), rgba(16,58,52,.65));
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(59,19,32,.95), rgba(59,19,32,.65));
    }
    .btn.ghost{
      background: rgba(10,18,34,.35);
    }
    .btn.small{
      padding:8px 10px;
      font-size:13px;
      border-radius:10px;
      width:auto;
      min-width:92px;
      white-space:nowrap;
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      filter:none;
    }

    /* Tables */
    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:12px;
      background: rgba(10,18,34,.35);
    }
    .table th, .table td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 10px;
      font-size:13px;
      vertical-align:top;
    }
    .table th{
      font-size:12px;
      color:var(--muted);
      text-align:left;
      background: rgba(12,21,39,.55);
      position:sticky;
      top:0;
      z-index:1;
    }
    .table tr:last-child td{ border-bottom:none; }
    .right{ text-align:right; }
    .muted{ color:var(--muted); }
    .mini{ font-size:12px; color:rgba(151,163,182,.90); margin-top:2px; }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 720px){
      .split{ grid-template-columns: 1fr; }
    }

    /* KPI */
    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .kpis{ grid-template-columns: 1fr; }
    }
    .kpi{
      border:1px solid var(--line);
      border-radius:12px;
      background: rgba(10,18,34,.35);
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .kpi:before{
      content:"";
      position:absolute; inset:-40% -40% auto auto;
      width:140px; height:140px;
      background: radial-gradient(circle at 30% 30%, rgba(96,165,250,.22), transparent 60%);
      transform: rotate(12deg);
      pointer-events:none;
    }
    .kpi .t{ font-size:12px; color:var(--muted); }
    .kpi .v{ font-size:18px; font-weight:850; margin-top:6px; }
    .kpi .sub{ margin-top:6px; font-size:12px; color:rgba(151,163,182,.9); }

    .divider{ height:1px; background:rgba(255,255,255,.08); margin:12px 0; }

    /* Tight controls */
    .tight input, .tight select{ padding:10px 11px; }
    .tight .has-prefix input{ padding-left:28px; }

    /* Toast */
    .toastHost{
      position:fixed;
      right:14px;
      bottom:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:999;
      max-width: calc(100vw - 28px);
    }
    .toast{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,18,34,.90);
      backdrop-filter: blur(10px);
      border-radius:14px;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      padding:12px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      animation: pop .18s ease-out;
    }
    @keyframes pop{ from{ transform: translateY(10px); opacity:0; } to{ transform: translateY(0); opacity:1; } }
    .toast .ic{
      width:32px; height:32px; border-radius:10px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      flex:0 0 auto;
      font-weight:900;
    }
    .toast.ok  .ic{ background: rgba(82,255,176,.10); border-color: rgba(82,255,176,.22); color: var(--green); }
    .toast.warn .ic{ background: rgba(255,209,90,.10); border-color: rgba(255,209,90,.22); color: var(--amber); }
    .toast.bad .ic{ background: rgba(255,90,122,.10); border-color: rgba(255,90,122,.22); color: var(--red); }
    .toast .tt{ font-weight:800; font-size:13px; }
    .toast .tx{ font-size:12px; color: rgba(151,163,182,.92); margin-top:2px; }
    .toast .x{
      margin-left:auto;
      background:transparent;
      border: none;
      color: rgba(151,163,182,.9);
      width:auto;
      padding:4px 6px;
      cursor:pointer;
      font-size:16px;
      line-height:1;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <b>Costeo BOM</b>
        <span>Materia prima → Producto final</span>
      </div>

      <div class="pill" id="statusPill" title="Estado del producto">
        <span class="dot warn" id="statusDot"></span>
        <span id="statusText">Sin producto seleccionado</span>
      </div>

      <div class="selector tight">
        <select id="pfSelect" aria-label="Producto"></select>
        <button class="btn small ghost" id="btnNewPF" type="button">Nuevo</button>
      </div>

      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn small ghost" id="btnExport" type="button">Exportar</button>
        <button class="btn small ghost" id="btnImport" type="button">Importar</button>
        <button class="btn small danger" id="btnWipe" type="button">Borrar todo</button>
      </div>
    </div>
  </div>

  <main class="wrap">
    <!-- Left column: Materias primas -->
    <section class="card">
      <div class="hd">
        <b>Materias primas</b>
        <span class="muted" style="font-size:12px;">Catálogo</span>
      </div>
      <div class="bd">
        <div class="grid2 tight">
          <div class="field" id="f_mpCode">
            <label>Código *</label>
            <input id="mpCode" placeholder="MP-APPLE" autocomplete="off"/>
            <div class="err">Campo obligatorio.</div>
          </div>
          <div class="field has-prefix" id="f_mpCost">
            <label>Costo unitario *</label>
            <span class="prefix">$</span>
            <input id="mpCost" type="number" step="0.01" placeholder="0.00" inputmode="decimal"/>
            <div class="err">Captura un costo válido (≥ 0).</div>
          </div>
          <div class="field" style="grid-column:1/-1" id="f_mpDesc">
            <label>Descripción *</label>
            <input id="mpDesc" placeholder="Manzana verde (pieza)" autocomplete="off"/>
            <div class="err">Campo obligatorio.</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn secondary" id="btnAddMP" type="button">Guardar materia prima</button>
        </div>

        <div class="divider"></div>

        <div style="max-height:420px; overflow:auto; border-radius:12px;">
          <table class="table" id="mpTable">
            <thead>
              <tr>
                <th style="width:140px;">Código</th>
                <th>Descripción</th>
                <th class="right" style="width:130px;">Costo</th>
                <th class="right" style="width:140px;">Acción</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="mini">
          Define el costo unitario por tu unidad (pieza / gramo / ml) y usa esa misma unidad en la receta.
        </div>
      </div>
    </section>

    <!-- Right column: Producto + receta -->
    <section class="card">
      <div class="hd">
        <b>Producto y receta</b>
        <span class="muted" style="font-size:12px;" id="pfHint">—</span>
      </div>
      <div class="bd">

        <div class="split tight">
          <div class="field" id="f_pfCode">
            <label>Código del producto *</label>
            <input id="pfCode" placeholder="PF-MANZANA" autocomplete="off"/>
            <div class="err">Campo obligatorio.</div>
          </div>
          <div class="field" id="f_pfDailyQty">
            <label>Piezas del día *</label>
            <input id="pfDailyQty" type="number" step="1" placeholder="0" inputmode="numeric"/>
            <div class="err">Captura una cantidad válida (≥ 0).</div>
          </div>
          <div class="field" style="grid-column:1/-1" id="f_pfDesc">
            <label>Descripción *</label>
            <input id="pfDesc" placeholder="Manzana preparada" autocomplete="off"/>
            <div class="err">Campo obligatorio.</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="btnSavePF" type="button">Guardar producto</button>
        </div>

        <div class="divider"></div>

        <div class="kpis">
          <div class="kpi">
            <div class="t">Costo de producción (unitario)</div>
            <div class="v" id="kpiUnit">$0.00</div>
            <div class="sub" id="kpiUnitSub">—</div>
          </div>
          <div class="kpi">
            <div class="t">Costo total del día (producción)</div>
            <div class="v" id="kpiDay">$0.00</div>
            <div class="sub" id="kpiDaySub">—</div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Venta -->
        <div class="split tight">
          <div class="field" id="f_margin">
            <label>Margen de ganancia (%)</label>
            <input id="pfMargin" type="number" step="1" placeholder="40" inputmode="numeric"/>
            <div class="help">Por defecto 40%. Puedes cambiarlo.</div>
          </div>
          <div class="field has-prefix" id="f_sellPrice">
            <label>Precio de venta (unitario)</label>
            <span class="prefix">$</span>
            <input id="pfSellPrice" type="number" step="0.01" placeholder="0.00" inputmode="decimal"/>
            <div class="help">Puedes editarlo. Si no lo tocas, se calcula con el margen.</div>
          </div>
          <div class="field has-prefix" style="grid-column:1/-1" id="f_sellDay">
            <label>Venta total del día</label>
            <span class="prefix">$</span>
            <input id="pfSellDay" type="number" step="0.01" placeholder="0.00" inputmode="decimal" disabled />
            <div class="help">Automático: precio venta × piezas del día.</div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Receta -->
        <div class="row tight">
          <div class="field" style="min-width:240px;" id="f_recipeMP">
            <label>Materia prima *</label>
            <select id="recipeMP"></select>
            <div class="err">Selecciona una materia prima.</div>
          </div>
          <div class="field" style="min-width:140px;" id="f_recipeQty">
            <label>Cantidad *</label>
            <input id="recipeQty" type="number" step="0.01" placeholder="0" inputmode="decimal"/>
            <div class="err">Captura una cantidad > 0.</div>
          </div>
          <div class="field" style="min-width:240px;">
            <label>Nota</label>
            <input id="recipeNote" placeholder="opcional" autocomplete="off"/>
            <div class="help">Ej: “chamoy”, “gomitas mixtas”.</div>
          </div>
          <div style="min-width:160px;">
            <label>&nbsp;</label>
            <button class="btn secondary" id="btnAddLine" type="button">Agregar a receta</button>
          </div>
        </div>

        <div style="margin-top:12px; max-height:380px; overflow:auto; border-radius:12px;">
          <table class="table" id="recipeTable">
            <thead>
              <tr>
                <th>Insumo</th>
                <th class="right" style="width:110px;">Cant.</th>
                <th class="right" style="width:130px;">Costo</th>
                <th>Nota</th>
                <th class="right" style="width:90px;">Acción</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="divider"></div>

        <label>Respaldo (JSON)</label>
        <textarea id="jsonBox" placeholder="Exportar genera un respaldo aquí. Importar: pega aquí y aplica."></textarea>
      </div>
    </section>
  </main>

  <div class="toastHost" id="toastHost"></div>

<script>
(() => {
  // ---------------- IndexedDB (persistencia confiable) ----------------
  const DB_NAME = "costeo_bom_db_pro";
  const DB_VER  = 2; // subimos versión por nuevos campos
  const STORE   = "state";
  const KEY     = "APP";

  function openDB(){
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = () => {
        const db = req.result;
        if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async function dbGet(k){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readonly");
      const st = tx.objectStore(STORE);
      const r  = st.get(k);
      r.onsuccess = () => resolve(r.result);
      r.onerror   = () => reject(r.error);
      tx.oncomplete = () => db.close();
    });
  }
  async function dbSet(k, v){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readwrite");
      const st = tx.objectStore(STORE);
      const r  = st.put(v, k);
      r.onsuccess = () => resolve(true);
      r.onerror   = () => reject(r.error);
      tx.oncomplete = () => db.close();
    });
  }
  async function dbClear(){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readwrite");
      const st = tx.objectStore(STORE);
      const r  = st.clear();
      r.onsuccess = () => resolve(true);
      r.onerror   = () => reject(r.error);
      tx.oncomplete = () => db.close();
    });
  }

  // ---------------- Helpers ----------------
  const $ = (id) => document.getElementById(id);
  const norm  = (s) => String(s||"").trim();
  const money = (n) => Number(n||0).toLocaleString("es-MX", {style:"currency", currency:"MXN"});
  const round2 = (n) => Math.round((Number(n||0) + Number.EPSILON) * 100) / 100;

  function safeText(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // Toast
  function toast(type, title, text, ms=2600){
    const host = $("toastHost");
    const el = document.createElement("div");
    el.className = `toast ${type}`;
    const icon = type === "ok" ? "✓" : type === "warn" ? "!" : "×";
    el.innerHTML = `
      <div class="ic">${icon}</div>
      <div>
        <div class="tt">${safeText(title)}</div>
        <div class="tx">${safeText(text)}</div>
      </div>
      <button class="x" type="button" aria-label="Cerrar">✕</button>
    `;
    host.appendChild(el);
    const kill = () => { el.remove(); };
    el.querySelector(".x").addEventListener("click", kill);
    setTimeout(kill, ms);
  }

  // Validation UI helpers
  function setInvalid(fieldId, on, msg){
    const f = $(fieldId);
    if(!f) return;
    f.classList.toggle("invalid", !!on);
    if(msg){
      const err = f.querySelector(".err");
      if(err) err.textContent = msg;
    }
  }
  function clearInvalidAll(){
    ["f_mpCode","f_mpCost","f_mpDesc","f_pfCode","f_pfDailyQty","f_pfDesc","f_recipeMP","f_recipeQty"].forEach(id=>setInvalid(id,false));
  }

  // ---------------- State ----------------
  const state = { mp: [], products: [], selected: "" };

  function findMP(code){ return state.mp.find(x => x.code === code); }
  function findPF(code){ return state.products.find(p => p.code === code); }
  function selPF(){ return state.selected ? findPF(state.selected) : null; }

  async function load(){
    const saved = await dbGet(KEY);
    if(saved && typeof saved === "object"){
      state.mp = Array.isArray(saved.mp) ? saved.mp : [];
      state.products = Array.isArray(saved.products) ? saved.products : [];
      state.selected = saved.selected || "";
    }
    // Backfill nuevos campos (si ya existían productos antiguos)
    state.products.forEach(p=>{
      if(p.marginPct == null) p.marginPct = 40;
      if(p.sellPrice == null) p.sellPrice = null; // null = auto
      if(p.recipe == null) p.recipe = [];
      if(p.dailyQty == null) p.dailyQty = 0;
      if(p.desc == null) p.desc = "";
    });
  }
  async function save(){
    await dbSet(KEY, { mp: state.mp, products: state.products, selected: state.selected });
  }

  // ---------------- Calculations ----------------
  function calcUnitCost(p){
    if(!p) return 0;
    let sum = 0;
    (p.recipe||[]).forEach(r=>{
      const mp = findMP(r.mpCode);
      const qty = Number(r.qty||0);
      const c = (mp ? Number(mp.cost||0) : 0);
      sum += qty * c;
    });
    return round2(sum);
  }

  function calcSellPrice(p){
    if(!p) return 0;
    const unit = calcUnitCost(p);
    const pct = Number(p.marginPct ?? 40);
    const auto = round2(unit * (1 + (pct/100)));
    const manual = Number(p.sellPrice);
    // si manual es válido (>=0), usar manual, si no auto
    if(Number.isFinite(manual) && manual >= 0) return round2(manual);
    return auto;
  }

  function statusForProduct(p){
    if(!p) return { dot:"warn", text:"Sin producto seleccionado" };
    const hasRecipe = (p.recipe||[]).length > 0;
    const unit = calcUnitCost(p);
    if(!hasRecipe) return { dot:"warn", text:`${p.code} — sin receta` };
    if(unit <= 0) return { dot:"warn", text:`${p.code} — revisa costos` };
    return { dot:"ok", text:`${p.code} — listo` };
  }

  // ---------------- Render ----------------
  function renderAll(){
    renderPFSelect();
    renderMPSelectForRecipe();
    renderMPTable();
    renderPFForm();
    renderRecipe();
    renderTotalsAndSell();
    renderStatus();
    syncButtons();
  }

  function renderStatus(){
    const p = selPF();
    const st = statusForProduct(p);
    $("statusDot").className = `dot ${st.dot}`;
    $("statusText").textContent = st.text;
  }

  function renderPFSelect(){
    const s = $("pfSelect");
    s.innerHTML = "";

    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = state.products.length ? "Seleccionar producto…" : "Sin productos";
    s.appendChild(opt0);

    state.products
      .slice().sort((a,b)=>a.code.localeCompare(b.code))
      .forEach(p=>{
        const o = document.createElement("option");
        o.value = p.code;
        o.textContent = `${p.code} — ${p.desc || ""}`.trim();
        if(p.code === state.selected) o.selected = true;
        s.appendChild(o);
      });

    s.onchange = async () => {
      state.selected = s.value;
      await save();
      renderAll();
    };
  }

  function renderPFForm(){
    const p = selPF();
    $("pfHint").textContent = p ? p.code : "—";

    $("pfCode").value = p ? p.code : "";
    $("pfDesc").value = p ? (p.desc || "") : "";
    $("pfDailyQty").value = p ? (p.dailyQty ?? 0) : 0;

    $("pfMargin").value = p ? (p.marginPct ?? 40) : 40;

    // si es null => mostrar vacío (auto)
    $("pfSellPrice").value = p
      ? (p.sellPrice == null ? "" : Number(p.sellPrice))
      : "";
  }

  function renderMPSelectForRecipe(){
    const s = $("recipeMP");
    s.innerHTML = "";
    if(!state.mp.length){
      const o = document.createElement("option");
      o.value = "";
      o.textContent = "Agrega materias primas…";
      s.appendChild(o);
      s.disabled = true;
      return;
    }
    s.disabled = false;
    state.mp
      .slice().sort((a,b)=>a.code.localeCompare(b.code))
      .forEach(mp=>{
        const o = document.createElement("option");
        o.value = mp.code;
        o.textContent = `${mp.code} — ${mp.desc}`;
        s.appendChild(o);
      });
  }

  function renderMPTable(){
    const tb = $("mpTable").querySelector("tbody");
    tb.innerHTML = "";

    const rows = state.mp.slice().sort((a,b)=>a.code.localeCompare(b.code));
    if(!rows.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" class="muted">Sin materias primas</td>`;
      tb.appendChild(tr);
      return;
    }

    rows.forEach(mp=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${safeText(mp.code)}</b></td>
        <td>${safeText(mp.desc)}</td>
        <td class="right">${money(mp.cost)}</td>
        <td class="right">
          <button class="btn small ghost" data-edit="${safeText(mp.code)}" type="button">Editar</button>
          <button class="btn small danger" data-del="${safeText(mp.code)}" type="button">X</button>
        </td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const code = btn.getAttribute("data-del");
        state.mp = state.mp.filter(x => x.code !== code);
        state.products.forEach(p=>{
          p.recipe = (p.recipe || []).filter(r => r.mpCode !== code);
        });
        await save();
        renderAll();
        toast("ok","Actualizado","Materia prima eliminada y removida de recetas.");
      });
    });

    tb.querySelectorAll("[data-edit]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const code = btn.getAttribute("data-edit");
        const mp = findMP(code);
        if(!mp) return;
        $("mpCode").value = mp.code;
        $("mpDesc").value = mp.desc;
        $("mpCost").value = mp.cost;
        $("mpCode").focus();
        toast("warn","Edición","Modifica y vuelve a guardar la materia prima.");
      });
    });
  }

  function renderRecipe(){
    const tb = $("recipeTable").querySelector("tbody");
    tb.innerHTML = "";

    const p = selPF();
    if(!p){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5" class="muted">Selecciona o crea un producto</td>`;
      tb.appendChild(tr);
      return;
    }

    const recipe = (p.recipe || []);
    if(!recipe.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5" class="muted">Sin receta</td>`;
      tb.appendChild(tr);
      return;
    }

    recipe.forEach((r, idx)=>{
      const mp = findMP(r.mpCode);
      const qty = Number(r.qty||0);
      const cost = round2((mp ? Number(mp.cost||0) : 0) * qty);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <b>${safeText(r.mpCode)}</b>
          <div class="mini">${safeText(mp ? mp.desc : "")}</div>
        </td>
        <td class="right">${qty.toLocaleString("es-MX",{maximumFractionDigits:4})}</td>
        <td class="right">${money(cost)}</td>
        <td>${safeText(r.note || "")}</td>
        <td class="right">
          <button class="btn small danger" data-rdel="${idx}" type="button">X</button>
        </td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll("[data-rdel]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const idx = Number(btn.getAttribute("data-rdel"));
        const p = selPF();
        if(!p) return;
        p.recipe = (p.recipe || []);
        if(idx >= 0 && idx < p.recipe.length) p.recipe.splice(idx, 1);
        await save();
        renderAll();
        toast("ok","Actualizado","Línea eliminada de la receta.");
      });
    });
  }

  function renderTotalsAndSell(){
    const p = selPF();
    const unit = calcUnitCost(p);
    const dayQty = p ? Number(p.dailyQty||0) : 0;
    const prodDay = round2(unit * dayQty);

    $("kpiUnit").textContent = money(unit);
    $("kpiDay").textContent  = money(prodDay);

    $("kpiUnitSub").textContent = p
      ? `Receta: ${(p.recipe||[]).length} insumo(s)`
      : "—";

    $("kpiDaySub").textContent = p
      ? `Piezas del día: ${dayQty.toLocaleString("es-MX")}`
      : "—";

    const sellUnit = calcSellPrice(p);
    const sellDay = round2(sellUnit * dayQty);

    // render venta (inputs)
    $("pfSellDay").value = (p ? sellDay : 0).toFixed(2);
    // si no hay producto seleccionado, dejamos sellPrice vacío
    if(!p){
      $("pfSellPrice").value = "";
      $("pfMargin").value = 40;
    }
  }

  function syncButtons(){
    // Deshabilitar agregar receta si no hay producto
    const p = selPF();
    $("btnAddLine").disabled = !p || !state.mp.length;
  }

  // ---------------- Validation ----------------
  function validateMP(){
    clearInvalidAll();
    const code = norm($("mpCode").value);
    const desc = norm($("mpDesc").value);
    const cost = Number($("mpCost").value);

    let ok = true;
    if(!code){ setInvalid("f_mpCode", true); ok=false; }
    if(!desc){ setInvalid("f_mpDesc", true); ok=false; }
    if(!(Number.isFinite(cost) && cost >= 0)){ setInvalid("f_mpCost", true, "Captura un costo válido (≥ 0)."); ok=false; }

    if(!ok) toast("bad","Faltan datos","Completa los campos obligatorios de materia prima.");
    return ok;
  }

  function validatePF(){
    clearInvalidAll();
    const code = norm($("pfCode").value);
    const desc = norm($("pfDesc").value);
    const dailyQty = Number($("pfDailyQty").value);

    let ok = true;
    if(!code){ setInvalid("f_pfCode", true); ok=false; }
    if(!desc){ setInvalid("f_pfDesc", true); ok=false; }
    if(!(Number.isFinite(dailyQty) && dailyQty >= 0)){ setInvalid("f_pfDailyQty", true, "Captura una cantidad válida (≥ 0)."); ok=false; }

    if(!ok) toast("bad","Faltan datos","Completa los campos obligatorios del producto.");
    return ok;
  }

  function validateRecipeLine(){
    clearInvalidAll();
    const p = selPF();
    let ok = true;

    if(!p){
      toast("bad","Sin producto","Selecciona o crea un producto para agregar receta.");
      return false;
    }

    const mpCode = $("recipeMP").value;
    const qty = Number($("recipeQty").value);

    if(!mpCode){ setInvalid("f_recipeMP", true); ok=false; }
    if(!(Number.isFinite(qty) && qty > 0)){ setInvalid("f_recipeQty", true); ok=false; }

    if(!ok) toast("bad","Faltan datos","Selecciona materia prima y captura una cantidad > 0.");
    return ok;
  }

  // ---------------- Actions ----------------
  $("btnAddMP").addEventListener("click", async ()=>{
    if(!validateMP()) return;

    const code = norm($("mpCode").value);
    const desc = norm($("mpDesc").value);
    const cost = round2(Number($("mpCost").value));

    const exists = findMP(code);
    if(exists){
      exists.desc = desc;
      exists.cost = cost;
      toast("ok","Guardado","Materia prima actualizada.");
    }else{
      state.mp.push({ code, desc, cost });
      toast("ok","Guardado","Materia prima agregada.");
    }

    $("mpCode").value = "";
    $("mpDesc").value = "";
    $("mpCost").value = "";

    await save();
    renderAll();
  });

  $("btnNewPF").addEventListener("click", async ()=>{
    state.selected = "";
    await save();
    renderAll();
    $("pfCode").focus();
    toast("warn","Nuevo","Captura un nuevo producto y guárdalo.");
  });

  $("btnSavePF").addEventListener("click", async ()=>{
    if(!validatePF()) return;

    const code = norm($("pfCode").value);
    const desc = norm($("pfDesc").value);
    const dailyQty = Number($("pfDailyQty").value);

    // margen / venta
    const marginPct = Number($("pfMargin").value);
    const sellPriceRaw = $("pfSellPrice").value.trim();
    const sellPrice = sellPriceRaw === "" ? null : round2(Number(sellPriceRaw));

    // validaciones suaves para margen/venta
    const marginOk = Number.isFinite(marginPct) && marginPct >= 0 && marginPct <= 1000;
    if(!marginOk){
      toast("warn","Margen inválido","Usaré 40% por defecto.");
    }
    const sellOk = (sellPrice === null) || (Number.isFinite(sellPrice) && sellPrice >= 0);
    if(!sellOk){
      toast("warn","Precio inválido","Se calculará automáticamente con el margen.");
    }

    let p = findPF(code);
    if(!p){
      p = { code, desc, dailyQty, recipe: [], marginPct: marginOk ? marginPct : 40, sellPrice: sellOk ? sellPrice : null };
      state.products.push(p);
    }else{
      p.code = code;
      p.desc = desc;
      p.dailyQty = dailyQty;
      p.recipe = p.recipe || [];
      p.marginPct = marginOk ? marginPct : (p.marginPct ?? 40);
      p.sellPrice = sellOk ? sellPrice : null;
    }

    state.selected = code;
    await save();
    renderAll();
    toast("ok","Guardado","Producto guardado correctamente.");
  });

  $("btnAddLine").addEventListener("click", async ()=>{
    if(!validateRecipeLine()) return;

    const p = selPF();
    const mpCode = $("recipeMP").value;
    const qty = round2(Number($("recipeQty").value));
    const note = norm($("recipeNote").value);

    p.recipe = p.recipe || [];
    const line = p.recipe.find(x => x.mpCode === mpCode);
    if(line){
      line.qty = round2(Number(line.qty||0) + qty);
      if(note) line.note = note;
    }else{
      p.recipe.push({ mpCode, qty, note });
    }

    $("recipeQty").value = "";
    $("recipeNote").value = "";

    await save();
    renderAll();
    toast("ok","Agregado","Se agregó la línea a la receta.");
  });

  $("btnWipe").addEventListener("click", async ()=>{
    if(!confirm("Borrar todo en este dispositivo?")) return;
    state.mp = [];
    state.products = [];
    state.selected = "";
    await dbClear();
    renderAll();
    toast("ok","Listo","Se borró toda la información del dispositivo.");
  });

  $("btnExport").addEventListener("click", ()=>{
    $("jsonBox").value = JSON.stringify({ mp: state.mp, products: state.products, selected: state.selected }, null, 2);
    $("jsonBox").focus();
    toast("ok","Exportado","Respaldo generado en JSON.");
  });

  $("btnImport").addEventListener("click", async ()=>{
    const raw = $("jsonBox").value.trim();
    if(!raw){
      toast("warn","Vacío","Pega un JSON para importar.");
      return;
    }
    try{
      const obj = JSON.parse(raw);
      state.mp = Array.isArray(obj.mp) ? obj.mp : [];
      state.products = Array.isArray(obj.products) ? obj.products : [];
      state.selected = obj.selected || "";

      // backfill
      state.products.forEach(p=>{
        if(p.marginPct == null) p.marginPct = 40;
        if(p.sellPrice == null) p.sellPrice = null;
        if(p.recipe == null) p.recipe = [];
        if(p.dailyQty == null) p.dailyQty = 0;
        if(p.desc == null) p.desc = "";
      });

      await save();
      renderAll();
      toast("ok","Importado","Datos aplicados correctamente.");
    }catch{
      toast("bad","JSON inválido","Revisa el contenido del respaldo.");
    }
  });

  // Auto-recalcular venta cuando cambia margen/precio/cantidad del día (sin guardar hasta que presione “Guardar producto”)
  ["pfMargin","pfSellPrice","pfDailyQty"].forEach(id=>{
    $(id).addEventListener("input", ()=>{
      renderTotalsAndSell();
    });
  });

  // Si el usuario borra el precio manual => vuelve a auto
  $("pfSellPrice").addEventListener("blur", ()=>{
    const v = $("pfSellPrice").value.trim();
    if(v === ""){
      renderTotalsAndSell();
    }
  });

  // ---------------- Init ----------------
  (async ()=>{
    await load();
    renderAll();
  })();
})();
</script>
</body>
</html>
