<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Costeo BOM</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e8eefc;
      --muted:#97a3b6;
      --line:rgba(255,255,255,.10);
      --focus:rgba(96,165,250,.40);

      --radius:16px;
      --shadow: 0 14px 40px rgba(0,0,0,.35);

      --red:#ff5a7a;
      --amber:#ffd15a;
      --green:#52ffb0;
      --blue:#60a5fa;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(96,165,250,.18), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(94,234,212,.12), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,18,32,.92), rgba(11,18,32,.72));
      border-bottom:1px solid var(--line);
    }
    .topbar .inner{
      max-width:1200px;
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
      min-width:230px;
    }
    .brand b{ font-size:14px; letter-spacing:.2px; }
    .brand span{ font-size:12px; color:var(--muted); }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,18,34,.35);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    .dot{
      width:9px; height:9px; border-radius:50%;
      background: rgba(255,255,255,.25);
      box-shadow: 0 0 0 3px rgba(255,255,255,.05);
    }
    .dot.ok{ background: rgba(82,255,176,.85); box-shadow: 0 0 0 3px rgba(82,255,176,.12); }
    .dot.warn{ background: rgba(255,209,90,.90); box-shadow: 0 0 0 3px rgba(255,209,90,.12); }
    .dot.bad{ background: rgba(255,90,122,.90); box-shadow: 0 0 0 3px rgba(255,90,122,.12); }

    .selector{
      flex:1;
      display:flex;
      gap:10px;
      align-items:center;
      min-width:300px;
    }

    /* Layout */
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:16px 14px 22px;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--line);
      background: rgba(12,21,39,.55);
    }
    .hd-left{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .icon{
      width:32px; height:32px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display:grid;
      place-items:center;
      font-size:16px;
      color: rgba(232,238,252,.92);
    }
    .card .hd b{ font-size:13px; letter-spacing:.2px; }
    .card .bd{ padding:14px; }

    /* Sections inside card */
    .section{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,18,34,.30);
      border-radius:14px;
      padding:12px;
      margin-bottom:12px;
    }
    .section:last-child{ margin-bottom:0; }
    .section .shd{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .section .shd .ttl{
      display:flex;
      gap:10px;
      align-items:center;
      font-weight:850;
      letter-spacing:.2px;
      font-size:13px;
    }
    .badge{
      font-size:11px;
      color: rgba(151,163,182,.95);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }

    /* Inputs */
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
    }
    .field{ position:relative; }
    input, select, textarea, button{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(10,18,34,.55);
      color:var(--text);
      padding:11px 11px;
      outline:none;
      font-size:14px;
    }
    input:focus, select:focus, textarea:focus{
      border-color: var(--focus);
      box-shadow: 0 0 0 3px rgba(96,165,250,.12);
    }
    textarea{ min-height:92px; resize:vertical; }

    .prefix{
      position:absolute;
      top:34px;
      left:11px;
      color:rgba(151,163,182,.85);
      font-size:13px;
      pointer-events:none;
    }
    .has-prefix input{ padding-left:28px; }

    .help{
      margin-top:6px;
      font-size:12px;
      color:rgba(151,163,182,.85);
    }
    .err{
      margin-top:6px;
      font-size:12px;
      color: rgba(255,90,122,.95);
      display:none;
    }

    .invalid input, .invalid select, .invalid textarea{
      border-color: rgba(255,90,122,.55);
      box-shadow: 0  0 0 3px rgba(255,90,122,.10);
    }
    .invalid .err{ display:block; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .grid2{ grid-template-columns: 1fr; }
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .row > *{ flex:1; }

    /* Buttons */
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(21,40,74,.9), rgba(21,40,74,.6));
      cursor:pointer;
      font-weight:650;
    }
    .btn:hover{ filter:brightness(1.06); }
    .btn.secondary{
      background: linear-gradient(180deg, rgba(16,58,52,.95), rgba(16,58,52,.65));
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(59,19,32,.95), rgba(59,19,32,.65));
    }
    .btn.ghost{
      background: rgba(10,18,34,.35);
    }
    .btn.small{
      padding:8px 10px;
      font-size:13px;
      border-radius:10px;
      width:auto;
      min-width:92px;
      white-space:nowrap;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; filter:none; }

    /* Tables */
    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:12px;
      background: rgba(10,18,34,.35);
    }
    .table th, .table td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 10px;
      font-size:13px;
      vertical-align:top;
    }
    .table th{
      font-size:12px;
      color:var(--muted);
      text-align:left;
      background: rgba(12,21,39,.55);
      position:sticky;
      top:0;
      z-index:1;
    }
    .table tr:last-child td{ border-bottom:none; }
    .right{ text-align:right; }
    .muted{ color:var(--muted); }
    .mini{ font-size:12px; color:rgba(151,163,182,.90); margin-top:2px; }

    /* KPIs */
    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .kpis{ grid-template-columns: 1fr; }
    }
    .kpi{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background: rgba(10,18,34,.35);
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .kpi:before{
      content:"";
      position:absolute; inset:-40% -40% auto auto;
      width:140px; height:140px;
      background: radial-gradient(circle at 30% 30%, rgba(96,165,250,.22), transparent 60%);
      transform: rotate(12deg);
      pointer-events:none;
    }
    .kpi .t{ font-size:12px; color:var(--muted); display:flex; gap:8px; align-items:center; }
    .kpi .v{ font-size:18px; font-weight:900; margin-top:6px; }
    .kpi .sub{ margin-top:6px; font-size:12px; color:rgba(151,163,182,.9); }

    /* Toast */
    .toastHost{
      position:fixed;
      right:14px;
      bottom:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:999;
      max-width: calc(100vw - 28px);
    }
    .toast{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,18,34,.90);
      backdrop-filter: blur(10px);
      border-radius:14px;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      padding:12px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      animation: pop .18s ease-out;
    }
    @keyframes pop{ from{ transform: translateY(10px); opacity:0; } to{ transform: translateY(0); opacity:1; } }
    .toast .ic{
      width:32px; height:32px; border-radius:10px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      flex:0 0 auto;
      font-weight:900;
    }
    .toast.ok  .ic{ background: rgba(82,255,176,.10); border-color: rgba(82,255,176,.22); color: var(--green); }
    .toast.warn .ic{ background: rgba(255,209,90,.10); border-color: rgba(255,209,90,.22); color: var(--amber); }
    .toast.bad .ic{ background: rgba(255,90,122,.10); border-color: rgba(255,90,122,.22); color: var(--red); }
    .toast .tt{ font-weight:900; font-size:13px; }
    .toast .tx{ font-size:12px; color: rgba(151,163,182,.92); margin-top:2px; }
    .toast .x{
      margin-left:auto;
      background:transparent;
      border: none;
      color: rgba(151,163,182,.9);
      width:auto;
      padding:4px 6px;
      cursor:pointer;
      font-size:16px;
      line-height:1;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <b>Costeo BOM</b>
        <span>Materia prima ‚Üí Producto final</span>
      </div>

      <div class="pill" id="statusPill" title="Estado del producto">
        <span class="dot warn" id="statusDot"></span>
        <span id="statusText">Sin producto seleccionado</span>
      </div>

      <div class="selector">
        <select id="pfSelect" aria-label="Producto"></select>
        <button class="btn small ghost" id="btnNewPF" type="button">Nuevo</button>
      </div>

      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn small ghost" id="btnExport" type="button">Exportar</button>
        <button class="btn small ghost" id="btnImport" type="button">Importar</button>
        <button class="btn small danger" id="btnWipe" type="button">Borrar todo</button>
      </div>
    </div>
  </div>

  <main class="wrap">
    <!-- Left: Materias primas -->
    <section class="card">
      <div class="hd">
        <div class="hd-left">
          <div class="icon">üßæ</div>
          <div>
            <b>Materias primas</b>
            <div class="mini">Cat√°logo de insumos</div>
          </div>
        </div>
        <span class="badge" id="mpCountBadge">0 insumos</span>
      </div>

      <div class="bd">
        <div class="section">
          <div class="shd">
            <div class="ttl"><span class="icon" style="width:28px;height:28px;border-radius:10px;">‚ûï</span>Agregar / editar insumo</div>
            <span class="badge">Campos con *</span>
          </div>

          <div class="grid2">
            <div class="field" id="f_mpCode">
              <label>C√≥digo *</label>
              <input id="mpCode" placeholder="MP-APPLE" autocomplete="off"/>
              <div class="err">Campo obligatorio.</div>
            </div>
            <div class="field has-prefix" id="f_mpCost">
              <label>Costo unitario *</label>
              <span class="prefix">$</span>
              <input id="mpCost" type="number" step="0.01" placeholder="0.00" inputmode="decimal"/>
              <div class="err">Captura un costo v√°lido (‚â• 0).</div>
            </div>
            <div class="field" style="grid-column:1/-1" id="f_mpDesc">
              <label>Descripci√≥n *</label>
              <input id="mpDesc" placeholder="Manzana verde (pieza)" autocomplete="off"/>
              <div class="err">Campo obligatorio.</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn secondary" id="btnAddMP" type="button">Guardar materia prima</button>
          </div>
        </div>

        <div class="section">
          <div class="shd">
            <div class="ttl"><span class="icon" style="width:28px;height:28px;border-radius:10px;">üì¶</span>Listado de insumos</div>
            <span class="badge">Editar / eliminar</span>
          </div>

          <div style="max-height:420px; overflow:auto; border-radius:12px;">
            <table class="table" id="mpTable">
              <thead>
                <tr>
                  <th style="width:140px;">C√≥digo</th>
                  <th>Descripci√≥n</th>
                  <th class="right" style="width:130px;">Costo</th>
                  <th class="right" style="width:140px;">Acci√≥n</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="help">
            Define el costo unitario por unidad (pieza / gramo / ml) y usa esa misma unidad en la receta.
          </div>
        </div>
      </div>
    </section>

    <!-- Right: Producto + receta -->
    <section class="card">
      <div class="hd">
        <div class="hd-left">
          <div class="icon">üè∑Ô∏è</div>
          <div>
            <b>Producto y receta</b>
            <div class="mini" id="pfHint">‚Äî</div>
          </div>
        </div>
        <span class="badge" id="pfBadge">‚Äî</span>
      </div>

      <div class="bd">
        <!-- Producto -->
        <div class="section">
          <div class="shd">
            <div class="ttl"><span class="icon" style="width:28px;height:28px;border-radius:10px;">üß©</span>Datos del producto</div>
            <span class="badge">Guardar para actualizar</span>
          </div>

          <div class="grid2">
            <div class="field" id="f_pfCode">
              <label>C√≥digo del producto *</label>
              <input id="pfCode" placeholder="PF-MANZANA" autocomplete="off"/>
              <div class="err">Campo obligatorio.</div>
            </div>
            <div class="field" id="f_pfDailyQty">
              <label>Piezas del d√≠a *</label>
              <input id="pfDailyQty" type="number" step="1" placeholder="0" inputmode="numeric"/>
              <div class="err">Captura una cantidad v√°lida (‚â• 0).</div>
            </div>
            <div class="field" style="grid-column:1/-1" id="f_pfDesc">
              <label>Descripci√≥n *</label>
              <input id="pfDesc" placeholder="Manzana preparada" autocomplete="off"/>
              <div class="err">Campo obligatorio.</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn" id="btnSavePF" type="button">Guardar producto</button>
          </div>
        </div>

        <!-- KPIs -->
        <div class="section">
          <div class="shd">
            <div class="ttl"><span class="icon" style="width:28px;height:28px;border-radius:10px;">üìä</span>Resumen de costos</div>
            <span class="badge">Auto-c√°lculo</span>
          </div>

          <div class="kpis">
            <div class="kpi">
              <div class="t">üßÆ Costo de producci√≥n (unitario)</div>
              <div class="v" id="kpiProdUnit">$0.00</div>
              <div class="sub" id="kpiProdUnitSub">‚Äî</div>
            </div>

            <!-- ESTE ES EL QUE CAMBIA: TOTAL DEL D√çA = VENTA TOTAL -->
            <div class="kpi">
              <div class="t">üí∞ Total del d√≠a (VENTA)</div>
              <div class="v" id="kpiSellDay">$0.00</div>
              <div class="sub" id="kpiSellDaySub">Incluye ganancia</div>
            </div>

            <div class="kpi">
              <div class="t">üßæ Total del d√≠a (PRODUCCI√ìN)</div>
              <div class="v" id="kpiProdDay">$0.00</div>
              <div class="sub" id="kpiProdDaySub">Costo √ó piezas</div>
            </div>

            <div class="kpi">
              <div class="t">üìå Precio de venta (unitario)</div>
              <div class="v" id="kpiSellUnit">$0.00</div>
              <div class="sub" id="kpiSellUnitSub">Producci√≥n + % ganancia</div>
            </div>
          </div>
        </div>

        <!-- Ganancia -->
        <div class="section">
          <div class="shd">
            <div class="ttl"><span class="icon" style="width:28px;height:28px;border-radius:10px;">‚öôÔ∏è</span>Ganancia</div>
            <span class="badge">Editable</span>
          </div>

          <div class="grid2">
            <div class="field" id="f_margin">
              <label>Porcentaje de ganancia (%)</label>
              <input id="pfMargin" type="number" step="1" placeholder="40" inputmode="numeric"/>
              <div class="help">Por defecto 40%. Cambia y se recalcula autom√°tico.</div>
            </div>

            <div class="field has-prefix">
              <label>Ganancia (unitaria)</label>
              <span class="prefix">$</span>
              <input id="pfProfitUnit" type="number" step="0.01" inputmode="decimal" disabled />
              <div class="help">Autom√°tico: producci√≥n √ó (ganancia%).</div>
            </div>

            <div class="field has-prefix" style="grid-column:1/-1">
              <label>Ganancia total del d√≠a</label>
              <span class="prefix">$</span>
              <input id="pfProfitDay" type="number" step="0.01" inputmode="decimal" disabled />
              <div class="help">Autom√°tico: ganancia unitaria √ó piezas del d√≠a.</div>
            </div>
          </div>
        </div>

        <!-- Receta -->
        <div class="section">
          <div class="shd">
            <div class="ttl"><span class="icon" style="width:28px;height:28px;border-radius:10px;">üß™</span>Receta (insumos)</div>
            <span class="badge">Agregar l√≠neas</span>
          </div>

          <div class="row">
            <div class="field" style="min-width:240px;" id="f_recipeMP">
              <label>Materia prima *</label>
              <select id="recipeMP"></select>
              <div class="err">Selecciona una materia prima.</div>
            </div>
            <div class="field" style="min-width:140px;" id="f_recipeQty">
              <label>Cantidad *</label>
              <input id="recipeQty" type="number" step="0.01" placeholder="0" inputmode="decimal"/>
              <div class="err">Captura una cantidad > 0.</div>
            </div>
            <div class="field" style="min-width:240px;">
              <label>Nota</label>
              <input id="recipeNote" placeholder="opcional" autocomplete="off"/>
              <div class="help">Ej: ‚Äúchamoy‚Äù, ‚Äúgomitas mixtas‚Äù.</div>
            </div>
            <div style="min-width:170px;">
              <label>&nbsp;</label>
              <button class="btn secondary" id="btnAddLine" type="button">Agregar a receta</button>
            </div>
          </div>

          <div style="margin-top:12px; max-height:380px; overflow:auto; border-radius:12px;">
            <table class="table" id="recipeTable">
              <thead>
                <tr>
                  <th>Insumo</th>
                  <th class="right" style="width:110px;">Cant.</th>
                  <th class="right" style="width:130px;">Costo</th>
                  <th>Nota</th>
                  <th class="right" style="width:90px;">Acci√≥n</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Respaldo -->
        <div class="section">
          <div class="shd">
            <div class="ttl"><span class="icon" style="width:28px;height:28px;border-radius:10px;">üõ°Ô∏è</span>Respaldo</div>
            <span class="badge">JSON</span>
          </div>
          <label>Respaldo (JSON)</label>
          <textarea id="jsonBox" placeholder="Exportar genera un respaldo aqu√≠. Importar: pega aqu√≠ y aplica."></textarea>
        </div>
      </div>
    </section>
  </main>

  <div class="toastHost" id="toastHost"></div>

<script>
(() => {
  // ---------------- IndexedDB ----------------
  const DB_NAME = "costeo_bom_db_pro";
  const DB_VER  = 3; // subimos por nuevos campos
  const STORE   = "state";
  const KEY     = "APP";

  function openDB(){
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = () => {
        const db = req.result;
        if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async function dbGet(k){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readonly");
      const st = tx.objectStore(STORE);
      const r  = st.get(k);
      r.onsuccess = () => resolve(r.result);
      r.onerror   = () => reject(r.error);
      tx.oncomplete = () => db.close();
    });
  }
  async function dbSet(k, v){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readwrite");
      const st = tx.objectStore(STORE);
      const r  = st.put(v, k);
      r.onsuccess = () => resolve(true);
      r.onerror   = () => reject(r.error);
      tx.oncomplete = () => db.close();
    });
  }
  async function dbClear(){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readwrite");
      const st = tx.objectStore(STORE);
      const r  = st.clear();
      r.onsuccess = () => resolve(true);
      r.onerror   = () => reject(r.error);
      tx.oncomplete = () => db.close();
    });
  }

  // ---------------- Helpers ----------------
  const $ = (id) => document.getElementById(id);
  const norm  = (s) => String(s||"").trim();
  const money = (n) => Number(n||0).toLocaleString("es-MX", {style:"currency", currency:"MXN"});
  const round2 = (n) => Math.round((Number(n||0) + Number.EPSILON) * 100) / 100;

  function safeText(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // Toast
  function toast(type, title, text, ms=2600){
    const host = $("toastHost");
    const el = document.createElement("div");
    el.className = `toast ${type}`;
    const icon = type === "ok" ? "‚úì" : type === "warn" ? "!" : "√ó";
    el.innerHTML = `
      <div class="ic">${icon}</div>
      <div>
        <div class="tt">${safeText(title)}</div>
        <div class="tx">${safeText(text)}</div>
      </div>
      <button class="x" type="button" aria-label="Cerrar">‚úï</button>
    `;
    host.appendChild(el);
    const kill = () => { el.remove(); };
    el.querySelector(".x").addEventListener("click", kill);
    setTimeout(kill, ms);
  }

  // Validation UI helpers
  function setInvalid(fieldId, on, msg){
    const f = $(fieldId);
    if(!f) return;
    f.classList.toggle("invalid", !!on);
    if(msg){
      const err = f.querySelector(".err");
      if(err) err.textContent = msg;
    }
  }
  function clearInvalidAll(){
    ["f_mpCode","f_mpCost","f_mpDesc","f_pfCode","f_pfDailyQty","f_pfDesc","f_recipeMP","f_recipeQty"].forEach(id=>setInvalid(id,false));
  }

  // ---------------- State ----------------
  const state = { mp: [], products: [], selected: "" };

  function findMP(code){ return state.mp.find(x => x.code === code); }
  function findPF(code){ return state.products.find(p => p.code === code); }
  function selPF(){ return state.selected ? findPF(state.selected) : null; }

  async function load(){
    const saved = await dbGet(KEY);
    if(saved && typeof saved === "object"){
      state.mp = Array.isArray(saved.mp) ? saved.mp : [];
      state.products = Array.isArray(saved.products) ? saved.products : [];
      state.selected = saved.selected || "";
    }
    // backfill
    state.products.forEach(p=>{
      if(p.marginPct == null) p.marginPct = 40;
      if(p.recipe == null) p.recipe = [];
      if(p.dailyQty == null) p.dailyQty = 0;
      if(p.desc == null) p.desc = "";
    });
  }
  async function save(){
    await dbSet(KEY, { mp: state.mp, products: state.products, selected: state.selected });
  }

  // ---------------- Calculations ----------------
  function calcUnitProdCost(p){
    if(!p) return 0;
    let sum = 0;
    (p.recipe||[]).forEach(r=>{
      const mp = findMP(r.mpCode);
      const qty = Number(r.qty||0);
      const c = (mp ? Number(mp.cost||0) : 0);
      sum += qty * c;
    });
    return round2(sum);
  }

  function calcMarginPct(p){
    const pct = Number(p?.marginPct ?? 40);
    // rango razonable
    if(!Number.isFinite(pct) || pct < 0) return 40;
    return pct;
  }

  function calcProfitUnit(p){
    const prodUnit = calcUnitProdCost(p);
    const pct = calcMarginPct(p);
    return round2(prodUnit * (pct/100));
  }

  function calcSellUnit(p){
    const prodUnit = calcUnitProdCost(p);
    const profitUnit = calcProfitUnit(p);
    return round2(prodUnit + profitUnit);
  }

  function statusForProduct(p){
    if(!p) return { dot:"warn", text:"Sin producto seleccionado" };
    const hasRecipe = (p.recipe||[]).length > 0;
    const prodUnit = calcUnitProdCost(p);
    if(!hasRecipe) return { dot:"warn", text:`${p.code} ‚Äî sin receta` };
    if(prodUnit <= 0) return { dot:"warn", text:`${p.code} ‚Äî revisa costos` };
    return { dot:"ok", text:`${p.code} ‚Äî listo` };
  }

  // ---------------- Render ----------------
  function renderAll(){
    renderPFSelect();
    renderMPSelectForRecipe();
    renderMPTable();
    renderPFForm();
    renderRecipe();
    renderKPIs();
    renderStatus();
    syncButtons();
  }

  function renderStatus(){
    const p = selPF();
    const st = statusForProduct(p);
    $("statusDot").className = `dot ${st.dot}`;
    $("statusText").textContent = st.text;

    $("pfBadge").textContent = p ? `${(p.recipe||[]).length} insumo(s)` : "‚Äî";
    $("mpCountBadge").textContent = `${state.mp.length} insumos`;
  }

  function renderPFSelect(){
    const s = $("pfSelect");
    s.innerHTML = "";

    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = state.products.length ? "Seleccionar producto‚Ä¶" : "Sin productos";
    s.appendChild(opt0);

    state.products
      .slice().sort((a,b)=>a.code.localeCompare(b.code))
      .forEach(p=>{
        const o = document.createElement("option");
        o.value = p.code;
        o.textContent = `${p.code} ‚Äî ${p.desc || ""}`.trim();
        if(p.code === state.selected) o.selected = true;
        s.appendChild(o);
      });

    s.onchange = async () => {
      state.selected = s.value;
      await save();
      renderAll();
    };
  }

  function renderPFForm(){
    const p = selPF();
    $("pfHint").textContent = p ? p.code : "‚Äî";

    $("pfCode").value = p ? p.code : "";
    $("pfDesc").value = p ? (p.desc || "") : "";
    $("pfDailyQty").value = p ? (p.dailyQty ?? 0) : 0;
    $("pfMargin").value = p ? (p.marginPct ?? 40) : 40;
  }

  function renderMPSelectForRecipe(){
    const s = $("recipeMP");
    s.innerHTML = "";
    if(!state.mp.length){
      const o = document.createElement("option");
      o.value = "";
      o.textContent = "Agrega materias primas‚Ä¶";
      s.appendChild(o);
      s.disabled = true;
      return;
    }
    s.disabled = false;
    state.mp
      .slice().sort((a,b)=>a.code.localeCompare(b.code))
      .forEach(mp=>{
        const o = document.createElement("option");
        o.value = mp.code;
        o.textContent = `${mp.code} ‚Äî ${mp.desc}`;
        s.appendChild(o);
      });
  }

  function renderMPTable(){
    const tb = $("mpTable").querySelector("tbody");
    tb.innerHTML = "";

    const rows = state.mp.slice().sort((a,b)=>a.code.localeCompare(b.code));
    if(!rows.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" class="muted">Sin materias primas</td>`;
      tb.appendChild(tr);
      return;
    }

    rows.forEach(mp=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${safeText(mp.code)}</b></td>
        <td>${safeText(mp.desc)}</td>
        <td class="right">${money(mp.cost)}</td>
        <td class="right">
          <button class="btn small ghost" data-edit="${safeText(mp.code)}" type="button">Editar</button>
          <button class="btn small danger" data-del="${safeText(mp.code)}" type="button">X</button>
        </td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const code = btn.getAttribute("data-del");
        state.mp = state.mp.filter(x => x.code !== code);
        state.products.forEach(p=>{
          p.recipe = (p.recipe || []).filter(r => r.mpCode !== code);
        });
        await save();
        renderAll();
        toast("ok","Actualizado","Materia prima eliminada y removida de recetas.");
      });
    });

    tb.querySelectorAll("[data-edit]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const code = btn.getAttribute("data-edit");
        const mp = findMP(code);
        if(!mp) return;
        $("mpCode").value = mp.code;
        $("mpDesc").value = mp.desc;
        $("mpCost").value = mp.cost;
        $("mpCode").focus();
        toast("warn","Edici√≥n","Modifica y vuelve a guardar la materia prima.");
      });
    });
  }

  function renderRecipe(){
    const tb = $("recipeTable").querySelector("tbody");
    tb.innerHTML = "";

    const p = selPF();
    if(!p){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5" class="muted">Selecciona o crea un producto</td>`;
      tb.appendChild(tr);
      return;
    }

    const recipe = (p.recipe || []);
    if(!recipe.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5" class="muted">Sin receta</td>`;
      tb.appendChild(tr);
      return;
    }

    recipe.forEach((r, idx)=>{
      const mp = findMP(r.mpCode);
      const qty = Number(r.qty||0);
      const cost = round2((mp ? Number(mp.cost||0) : 0) * qty);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <b>${safeText(r.mpCode)}</b>
          <div class="mini">${safeText(mp ? mp.desc : "")}</div>
        </td>
        <td class="right">${qty.toLocaleString("es-MX",{maximumFractionDigits:4})}</td>
        <td class="right">${money(cost)}</td>
        <td>${safeText(r.note || "")}</td>
        <td class="right">
          <button class="btn small danger" data-rdel="${idx}" type="button">X</button>
        </td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll("[data-rdel]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const idx = Number(btn.getAttribute("data-rdel"));
        const p = selPF();
        if(!p) return;
        p.recipe = (p.recipe || []);
        if(idx >= 0 && idx < p.recipe.length) p.recipe.splice(idx, 1);
        await save();
        renderAll();
        toast("ok","Actualizado","L√≠nea eliminada de la receta.");
      });
    });
  }

  function renderKPIs(){
    const p = selPF();
    const dayQty = p ? Number(p.dailyQty||0) : 0;

    const prodUnit = calcUnitProdCost(p);
    const prodDay = round2(prodUnit * dayQty);

    const pct = calcMarginPct(p);
    const profitUnit = calcProfitUnit(p);
    const profitDay = round2(profitUnit * dayQty);

    const sellUnit = calcSellUnit(p);
    const sellDay  = round2(sellUnit * dayQty);

    $("kpiProdUnit").textContent = money(prodUnit);
    $("kpiProdDay").textContent  = money(prodDay);

    $("kpiSellUnit").textContent = money(sellUnit);
    $("kpiSellDay").textContent  = money(sellDay);

    $("kpiProdUnitSub").textContent = p ? `Receta: ${(p.recipe||[]).length} insumo(s)` : "‚Äî";
    $("kpiProdDaySub").textContent  = p ? `Piezas del d√≠a: ${dayQty.toLocaleString("es-MX")}` : "‚Äî";

    $("kpiSellUnitSub").textContent = `Ganancia: ${pct}%`;
    $("kpiSellDaySub").textContent  = `Producci√≥n ${money(prodDay)} + Ganancia ${money(profitDay)}`;

    $("pfProfitUnit").value = (p ? profitUnit : 0).toFixed(2);
    $("pfProfitDay").value  = (p ? profitDay : 0).toFixed(2);
  }

  function syncButtons(){
    const p = selPF();
    $("btnAddLine").disabled = !p || !state.mp.length;
  }

  // ---------------- Validation ----------------
  function validateMP(){
    clearInvalidAll();
    const code = norm($("mpCode").value);
    const desc = norm($("mpDesc").value);
    const cost = Number($("mpCost").value);

    let ok = true;
    if(!code){ setInvalid("f_mpCode", true); ok=false; }
    if(!desc){ setInvalid("f_mpDesc", true); ok=false; }
    if(!(Number.isFinite(cost) && cost >= 0)){ setInvalid("f_mpCost", true, "Captura un costo v√°lido (‚â• 0)."); ok=false; }

    if(!ok) toast("bad","Faltan datos","Completa los campos obligatorios de materia prima.");
    return ok;
  }

  function validatePF(){
    clearInvalidAll();
    const code = norm($("pfCode").value);
    const desc = norm($("pfDesc").value);
    const dailyQty = Number($("pfDailyQty").value);

    let ok = true;
    if(!code){ setInvalid("f_pfCode", true); ok=false; }
    if(!desc){ setInvalid("f_pfDesc", true); ok=false; }
    if(!(Number.isFinite(dailyQty) && dailyQty >= 0)){ setInvalid("f_pfDailyQty", true); ok=false; }

    if(!ok) toast("bad","Faltan datos","Completa los campos obligatorios del producto.");
    return ok;
  }

  function validateRecipeLine(){
    clearInvalidAll();
    const p = selPF();
    let ok = true;

    if(!p){
      toast("bad","Sin producto","Selecciona o crea un producto para agregar receta.");
      return false;
    }

    const mpCode = $("recipeMP").value;
    const qty = Number($("recipeQty").value);

    if(!mpCode){ setInvalid("f_recipeMP", true); ok=false; }
    if(!(Number.isFinite(qty) && qty > 0)){ setInvalid("f_recipeQty", true); ok=false; }

    if(!ok) toast("bad","Faltan datos","Selecciona materia prima y captura una cantidad > 0.");
    return ok;
  }

  // ---------------- Actions ----------------
  $("btnAddMP").addEventListener("click", async ()=>{
    if(!validateMP()) return;

    const code = norm($("mpCode").value);
    const desc = norm($("mpDesc").value);
    const cost = round2(Number($("mpCost").value));

    const exists = findMP(code);
    if(exists){
      exists.desc = desc;
      exists.cost = cost;
      toast("ok","Guardado","Materia prima actualizada.");
    }else{
      state.mp.push({ code, desc, cost });
      toast("ok","Guardado","Materia prima agregada.");
    }

    $("mpCode").value = "";
    $("mpDesc").value = "";
    $("mpCost").value = "";

    await save();
    renderAll();
  });

  $("btnNewPF").addEventListener("click", async ()=>{
    state.selected = "";
    await save();
    renderAll();
    $("pfCode").focus();
    toast("warn","Nuevo","Captura un nuevo producto y gu√°rdalo.");
  });

  $("btnSavePF").addEventListener("click", async ()=>{
    if(!validatePF()) return;

    const code = norm($("pfCode").value);
    const desc = norm($("pfDesc").value);
    const dailyQty = Number($("pfDailyQty").value);

    let marginPct = Number($("pfMargin").value);
    if(!Number.isFinite(marginPct) || marginPct < 0) marginPct = 40;

    let p = findPF(code);
    if(!p){
      p = { code, desc, dailyQty, recipe: [], marginPct };
      state.products.push(p);
    }else{
      p.code = code;
      p.desc = desc;
      p.dailyQty = dailyQty;
      p.recipe = p.recipe || [];
      p.marginPct = marginPct;
    }

    state.selected = code;
    await save();
    renderAll();
    toast("ok","Guardado","Producto guardado correctamente.");
  });

  $("btnAddLine").addEventListener("click", async ()=>{
    if(!validateRecipeLine()) return;

    const p = selPF();
    const mpCode = $("recipeMP").value;
    const qty = round2(Number($("recipeQty").value));
    const note = norm($("recipeNote").value);

    p.recipe = p.recipe || [];
    const line = p.recipe.find(x => x.mpCode === mpCode);
    if(line){
      line.qty = round2(Number(line.qty||0) + qty);
      if(note) line.note = note;
    }else{
      p.recipe.push({ mpCode, qty, note });
    }

    $("recipeQty").value = "";
    $("recipeNote").value = "";

    await save();
    renderAll();
    toast("ok","Agregado","Se agreg√≥ la l√≠nea a la receta.");
  });

  $("btnWipe").addEventListener("click", async ()=>{
    if(!confirm("Borrar todo en este dispositivo?")) return;
    state.mp = [];
    state.products = [];
    state.selected = "";
    await dbClear();
    renderAll();
    toast("ok","Listo","Se borr√≥ toda la informaci√≥n del dispositivo.");
  });

  $("btnExport").addEventListener("click", ()=>{
    $("jsonBox").value = JSON.stringify({ mp: state.mp, products: state.products, selected: state.selected }, null, 2);
    $("jsonBox").focus();
    toast("ok","Exportado","Respaldo generado en JSON.");
  });

  $("btnImport").addEventListener("click", async ()=>{
    const raw = $("jsonBox").value.trim();
    if(!raw){
      toast("warn","Vac√≠o","Pega un JSON para importar.");
      return;
    }
    try{
      const obj = JSON.parse(raw);
      state.mp = Array.isArray(obj.mp) ? obj.mp : [];
      state.products = Array.isArray(obj.products) ? obj.products : [];
      state.selected = obj.selected || "";

      state.products.forEach(p=>{
        if(p.marginPct == null) p.marginPct = 40;
        if(p.recipe == null) p.recipe = [];
        if(p.dailyQty == null) p.dailyQty = 0;
        if(p.desc == null) p.desc = "";
      });

      await save();
      renderAll();
      toast("ok","Importado","Datos aplicados correctamente.");
    }catch{
      toast("bad","JSON inv√°lido","Revisa el contenido del respaldo.");
    }
  });

  // Recalcular en vivo el % (sin guardar hasta que presiones Guardar producto)
  $("pfMargin").addEventListener("input", ()=>{
    const p = selPF();
    if(!p) return;
    const v = Number($("pfMargin").value);
    if(Number.isFinite(v) && v >= 0){
      // solo para preview visual, no persistimos hasta guardar
      p.marginPct_preview = v;
    }else{
      p.marginPct_preview = 40;
    }
    // usamos preview temporal si existe
    const original = p.marginPct;
    p.marginPct = p.marginPct_preview;
    renderKPIs();
    p.marginPct = original;
  });

  // si cambias piezas del d√≠a, que se refleje (preview)
  $("pfDailyQty").addEventListener("input", ()=>{
    renderKPIs();
  });

  // ---------------- Init ----------------
  (async ()=>{
    await load();
    renderAll();
  })();
})();
</script>
</body>
</html>
   
